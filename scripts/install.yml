- name: Check for automagic Project
  k8s_info:
    api_key: "{{ ocp_cluster_token | default(omit) }}"
    host: "{{ ocp_api_endpoint | default(omit) }}"
    api_version: project.openshift.io/v1
    kind: Project
    name: automagic
  register: project
  
- block:

    - name: Get OCP Apps domain
      include_role:
        name: common
        tasks_from: apps-endpoint
      vars:
        common_k8s_api_key: "{{ ocp_cluster_token | default(omit) }}"
        common_k8s_host: "{{ ocp_api_endpoint | default(omit) }}"
        common_output_to_var: "apps_endpoint_domain"

    - name: Prepare Usage md
      template:
        src: usage.md.j2
        dest: "{{ usage_directory }}/usage.md"
        mode: u+rwx

    - name: Set path to usage.md
      set_fact: 
        usage_path: "{{ usage_directory }}/usage.md"

    - name: Prepare usage Config Map
      template:
        src: usage-configmap.yaml.j2
        dest: "{{ usage_directory }}/usage-configmap.yaml"
        mode: u+rwx

    - name: Add the usage config map
      k8s:
        api_key: "{{ ocp_cluster_token | default(omit) }}"
        host: "{{ ocp_api_endpoint | default(omit) }}"
        state: present
        force: false
        merge_type: merge
        src: "{{ usage_directory }}/usage-configmap.yaml"
        wait: true
        wait_sleep: 15
        wait_timeout: 15

  when: project.resources | length != 0

- name: Install Catalog Source
  include_role:
    name: catalog_source

- name: Install Global CA
  include_role:
    name: global_ca

- name: Install DB2
  include_role:
    name: db2

- name: Install openldap
  include_role:
    name: openldap

- name: Install gitea
  include_role:
    name: gitea

- name: Install nexus
  include_role:
    name: nexus

- name: Install Mail
  include_role:
    name: mail

- name: Install Kibana
  include_role:
    name: kibana

- name: Install MongoDB
  include_role:
    name: mongodb

- name: Install CPFS
  include_role:
    name: cpfs

- name: Install CP4BA
  include_role:
    name: cp4ba
