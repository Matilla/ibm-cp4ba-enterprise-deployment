# Based on https://www.ibm.com/docs/en/cloud-paks/cp-biz-automation/21.0.3?topic=openshift-installing-production-deployments

- name: Execute Catalog Source role as prerequisite
  include_role:
    name: catalog_source
  vars:
    catalog_source_k8s_api_key: "{{ cp4ba_k8s_api_key | default(omit) }}"
    catalog_source_k8s_host: "{{ cp4ba_k8s_host | default(omit) }}"

- name: Create CP4BA directory for generated files
  file:
    path: "{{ cp4ba_output_directory }}"
    state: directory
    mode: u+rwx

- name: Repository
  include_tasks: repository.yml
  when: _cp4ba_run_repository == true

- name: DBs
  include_tasks: dbs.yml
  when: _cp4ba_run_dbs == true

- name: Predeploy
  include_tasks: predeploy.yml
  when: _cp4ba_run_predeploy == true

- name: Deploy
  include_tasks: deploy.yml
  when: _cp4ba_run_deploy == true
# TODO if failed, persist log and cr status copy_cp4ba_operator_log, copy_cp4ba_cr

- name: Postdeploy
  include_tasks: postdeploy.yml
  when: _cp4ba_run_postdeploy == true
